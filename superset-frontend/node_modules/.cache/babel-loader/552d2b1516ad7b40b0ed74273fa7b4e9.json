{"ast":null,"code":"import _mapInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/map\";import _concatInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/concat\";import _Number$isNaN from \"@babel/runtime-corejs3/core-js-stable/number/is-nan\";import _forEachInstanceProperty from \"@babel/runtime-corejs3/core-js-stable/instance/for-each\";(function () {var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;enterModule && enterModule(module);})();var __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {return a;}; /**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport { buildQueryContext, GenericDataType } from '@superset-ui/core';\nimport { DEFAULT_FORM_DATA } from './types';\nconst buildQuery = (formData, options) => {\n  const { search, coltypeMap } = (options == null ? void 0 : options.ownState) || {};\n  const { sortAscending, sortMetric } = { ...DEFAULT_FORM_DATA, ...formData };\n  return buildQueryContext(formData, (baseQueryObject) => {\n    const { columns = [], filters = [] } = baseQueryObject;\n    const extraFilters = [];\n    if (search) {\n      _forEachInstanceProperty(columns).call(columns, (column) => {\n        if (coltypeMap[column] === GenericDataType.STRING) {\n          extraFilters.push({\n            col: column,\n            op: 'ILIKE',\n            val: `%${search}%` });\n\n        } else\n        if (coltypeMap[column] === GenericDataType.NUMERIC &&\n        !_Number$isNaN(Number(search))) {\n          // for numeric columns we apply a >= where clause\n          extraFilters.push({\n            col: column,\n            op: '>=',\n            val: Number(search) });\n\n        }\n      });\n    }\n    const sortColumns = sortMetric ? [sortMetric] : columns;\n    const query = [\n    {\n      ...baseQueryObject,\n      groupby: columns,\n      metrics: sortMetric ? [sortMetric] : [],\n      filters: _concatInstanceProperty(filters).call(filters, extraFilters),\n      orderby: sortMetric || sortAscending !== undefined ?\n      _mapInstanceProperty(sortColumns).call(sortColumns, (column) => [column, !!sortAscending]) :\n      [] }];\n\n\n    return query;\n  });\n};const _default =\nbuildQuery;export default _default;;(function () {var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;if (!reactHotLoader) {return;}reactHotLoader.register(buildQuery, \"buildQuery\", \"/Users/frankhe/projects/superset/superset-frontend/src/filters/components/Select/buildQuery.ts\");reactHotLoader.register(_default, \"default\", \"/Users/frankhe/projects/superset/superset-frontend/src/filters/components/Select/buildQuery.ts\");})();;(function () {var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;leaveModule && leaveModule(module);})();","map":{"version":3,"sources":["/Users/frankhe/projects/superset/superset-frontend/src/filters/components/Select/buildQuery.ts"],"names":[],"mappings":"yoBAAA;;;;;;;;;;;;;;;;;AAiBG;AACH,SACE,iBADF,EAEE,eAFF,QAKO,mBALP;AAOA,SAAS,iBAAT,QAAmE,SAAnE;AAEA,MAAM,UAAU,GAAgD,CAC9D,QAD8D,EAE9D,OAF8D,KAG5D;AACF,QAAM,EAAE,MAAF,EAAU,UAAV,KAAyB,CAAA,OAAO,QAAP,YAAA,OAAO,CAAE,QAAT,KAAqB,EAApD;AACA,QAAM,EAAE,aAAF,EAAiB,UAAjB,KAAgC,EAAE,GAAG,iBAAL,EAAwB,GAAG,QAA3B,EAAtC;AACA,SAAO,iBAAiB,CAAC,QAAD,EAAW,CAAA,eAAe,KAAG;AACnD,UAAM,EAAE,OAAO,GAAG,EAAZ,EAAgB,OAAO,GAAG,EAA1B,KAAiC,eAAvC;AACA,UAAM,YAAY,GAA8B,EAAhD;AACA,QAAI,MAAJ,EAAY;AACV,+BAAA,OAAO,MAAP,CAAA,OAAO,EAAS,CAAA,MAAM,KAAG;AACvB,YAAI,UAAU,CAAC,MAAD,CAAV,KAAuB,eAAe,CAAC,MAA3C,EAAmD;AACjD,UAAA,YAAY,CAAC,IAAb,CAAkB;AAChB,YAAA,GAAG,EAAE,MADW;AAEhB,YAAA,EAAE,EAAE,OAFY;AAGhB,YAAA,GAAG,EAAE,IAAI,MAAM,GAHC,EAAlB;;AAKD,SAND;AAMO,YACL,UAAU,CAAC,MAAD,CAAV,KAAuB,eAAe,CAAC,OAAvC;AACA,SAAC,cAAa,MAAM,CAAC,MAAD,CAAnB,CAFI,EAGL;AACA;AACA,UAAA,YAAY,CAAC,IAAb,CAAkB;AAChB,YAAA,GAAG,EAAE,MADW;AAEhB,YAAA,EAAE,EAAE,IAFY;AAGhB,YAAA,GAAG,EAAE,MAAM,CAAC,MAAD,CAHK,EAAlB;;AAKD;AACF,OAlBM,CAAP;AAmBD;AAED,UAAM,WAAW,GAAG,UAAU,GAAG,CAAC,UAAD,CAAH,GAAkB,OAAhD;AACA,UAAM,KAAK,GAAkB;AAC3B;AACE,SAAG,eADL;AAEE,MAAA,OAAO,EAAE,OAFX;AAGE,MAAA,OAAO,EAAE,UAAU,GAAG,CAAC,UAAD,CAAH,GAAkB,EAHvC;AAIE,MAAA,OAAO,EAAE,wBAAA,OAAO,MAAP,CAAA,OAAO,EAAQ,YAAR,CAJlB;AAKE,MAAA,OAAO,EACL,UAAU,IAAI,aAAa,KAAK,SAAhC;AACI,2BAAA,WAAW,MAAX,CAAA,WAAW,EAAK,CAAA,MAAM,KAAI,CAAC,MAAD,EAAS,CAAC,CAAC,aAAX,CAAf,CADf;AAEI,QARR,EAD2B,CAA7B;;;AAYA,WAAO,KAAP;AACD,GAvCuB,CAAxB;AAwCD,CA9CD,C;AAgDe,U,CAAf,wB,iLAhDM,U","sourcesContent":["/**\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements.  See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership.  The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License.  You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied.  See the License for the\n * specific language governing permissions and limitations\n * under the License.\n */\nimport {\n  buildQueryContext,\n  GenericDataType,\n  QueryObject,\n  QueryObjectFilterClause,\n} from '@superset-ui/core';\nimport { BuildQuery } from '@superset-ui/core/lib/chart/registries/ChartBuildQueryRegistrySingleton';\nimport { DEFAULT_FORM_DATA, PluginFilterSelectQueryFormData } from './types';\n\nconst buildQuery: BuildQuery<PluginFilterSelectQueryFormData> = (\n  formData: PluginFilterSelectQueryFormData,\n  options,\n) => {\n  const { search, coltypeMap } = options?.ownState || {};\n  const { sortAscending, sortMetric } = { ...DEFAULT_FORM_DATA, ...formData };\n  return buildQueryContext(formData, baseQueryObject => {\n    const { columns = [], filters = [] } = baseQueryObject;\n    const extraFilters: QueryObjectFilterClause[] = [];\n    if (search) {\n      columns.forEach(column => {\n        if (coltypeMap[column] === GenericDataType.STRING) {\n          extraFilters.push({\n            col: column,\n            op: 'ILIKE',\n            val: `%${search}%`,\n          });\n        } else if (\n          coltypeMap[column] === GenericDataType.NUMERIC &&\n          !Number.isNaN(Number(search))\n        ) {\n          // for numeric columns we apply a >= where clause\n          extraFilters.push({\n            col: column,\n            op: '>=',\n            val: Number(search),\n          });\n        }\n      });\n    }\n\n    const sortColumns = sortMetric ? [sortMetric] : columns;\n    const query: QueryObject[] = [\n      {\n        ...baseQueryObject,\n        groupby: columns,\n        metrics: sortMetric ? [sortMetric] : [],\n        filters: filters.concat(extraFilters),\n        orderby:\n          sortMetric || sortAscending !== undefined\n            ? sortColumns.map(column => [column, !!sortAscending])\n            : [],\n      },\n    ];\n    return query;\n  });\n};\n\nexport default buildQuery;\n"],"sourceRoot":""},"metadata":{},"sourceType":"module"}